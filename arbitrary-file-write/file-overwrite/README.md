# Arbitrary File Overwrite

* as root or user you can overwrite a file and ...
	* fully control content
	* partially control content (eg. parts of a logfile)
	* none (empty file)

### pam
If we know enough about the target os we can overwrite their user authentication system logic with a backdoor. Here's an [example](https://infosecwriteups.com/creating-a-backdoor-in-pam-in-5-line-of-code-e23e99579cd9) that returns a successful login for a specific hardcoded password. 

### firefox profile redirection
In `~/.mozilla/firefox` by default, `installs.ini` and `profiles.ini` tell firefox which profiles it has and which one to select as default. We can change the profile folder to something we know that probaly exists like the two folders "Crash Reports" and "Pending Rings", and then configure settings there. The hex bit is from a special hash firefox uses called `cityhash` which the install path is processed with. 
#### Sample installs.ini

```
[4F96D1932A9F858E]
Default=yxaliytr.default
Locked=1
```

#### Sample profiles.ini
```
[Install4F96D1932A9F858E]
Default=yxaliytr.default
Locked=1

[Profile0]
Name=default
IsRelative=1
Path=yxaliytr.default
Default=1

[General]
StartWithLastProfile=1
Version=2
```

> The installs.ini file stores a hash of the installation path and locks a profile for this specific path to prevent other Firefox installations from using it. The profiles.ini file still stores all registered profiles and their paths and can include the data stored in installs.ini.

> Profile-per-install uses a hash of the install directory to identify different
installs of Firefox. This exposes the existing cityhash generated hash from
nsXREDirProvider and makes it available on all platforms.



[Source](https://support.mozilla.org/en-US/questions/1262122#:~:text=The%20installs.,the%20data%20stored%20in%20installs.) (need a better one)

[Profile Hashing Source](http://forums.mozillazine.org/viewtopic.php?p=14880915)

[Mozilla Bugzilla mentioning Cityhash](https://bugzilla.mozilla.org/show_bug.cgi?id=1474285)

On most systems the installl location can be guessed (`/usr/bin/firefox` for mine). However additional complexities may occur, for example Ubuntu is using snaps for packaging applications a lot more in the newer versions (TODO: Research firefox path in snap, I'm guessing the config file location will be in at least `$HOME/snap/firefox`).

TODO 2: POC of going from install directory to cityhash-ed hex digest. 

After redirecting, we can presetup a couple of things if we get a file create vulnerability, or we can overwrite some once firefox has been run once with the profile redirection. 

### firefox unused profile
Observation: a new profile that has not been launched at least once has a folder that contains only a `times.json` file with the contents 
```json
{
"created": 1659328302024,
"firstUse": null
}
```

### firefox used profile
#### prefs.js
Head:
```js
// Mozilla User Preferences

// DO NOT EDIT THIS FILE.
//
// If you make changes to this file while the application is running,
// the changes will be overwritten when the application exits.
//
// To change a preference value, you can either:
// - modify it via the UI (e.g. via about:config in the browser); or
// - set it within a user.js file in your profile.
```
We're going to do it anyways :P . For testing, I looked at the `browser.startup.homepage_override` prefixed ones and changed the url and expiry to some date in the future. 
```js
user_pref("browser.startup.homepage_override.buildID", "20220718155818");
user_pref("browser.startup.homepage_override.mstone", "103.0");
user_pref("browser.startup.homepage_override.once", "{\"message_id\":\"WNP_MOMENTS_13\",\"url\":\"https://www.mozilla.org/says_to_you/welcome/13\",\"expire\":1840908800000}");
```
This actually works even with that big scary warning, but only because I edited it **when firefox is not open**. To see what configuration opens we can control check out the specialized url `about:config` in firefox. Loads of things can be done from redirecting doh urls, setting proxy settings, **changing how content is sandboxed**, and more cool things. 